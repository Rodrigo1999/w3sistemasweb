function pb(e){return htmlentities.encode(e)}function dc(e){return e=JSON.stringify(e),e=htmlentities.decode(e),JSON.parse(e)}var express=require("express"),app=express(),http=require("http").createServer(app),io=require("socket.io")(http);const PORT=process.env.PORT||5e3,path=require("path");var pg=require("pg"),sharedsession=require("express-socket.io-session"),fs=require("fs"),compression=require("compression"),htmlentities=require("htmlentities"),directory=__dirname+"/views/readdingDbList.txt";if(fs.existsSync(directory))var file=fs.readFileSync(directory);else var file=!1;var session=require("express-session")({secret:"my-secret",resave:!0,saveUninitialized:!0});app.use(session),io.use(sharedsession(session,{autoSave:!0})),app.use(express["static"](path.join(__dirname,"public"))),app.use(compression());var d=new Date;app.set("view engine","ejs"),app.get("/",function(e,n){n.render("home",{date:d.getFullYear()})}),app.get("/admin/db",function(e,n,s){var r=e.session;r.login?pg.connect(process.env.DATABASE_URL,function(e,s,r){s.query("SELECT id, nome, email, mensagem, date FROM budget_message order by id desc",function(e,s){r(),e?(console.error(e),n.send("Error "+e)):n.render("db",{results:dc(s.rows),count:s.rows.length})})}):n.render("admin")}),app.get("*",function(e,n){n.render("404",{date:d.getFullYear()})}),io.on("connection",function(e){e.on("insertMsg",function(e,n){var s=d.getDate()+"/"+d.getMonth()+"/"+d.getFullYear()+" - "+d.getHours()+":"+d.getMinutes();pg.connect(process.env.DATABASE_URL,function(r,i,o){console.log(pb(e.nome));var t="'"+pb(e.nome.substr(0,150))+"', '"+pb(e.email.substr(0,150))+"', '"+pb(e.telefone.substr(0,15))+"', '"+pb(e.celular.substr(0,15))+"', '"+pb(e.mensagem)+"', '"+s+"'";i.query("insert into budget_message (nome, email, telefone, celular, mensagem, date) values ("+t+")",function(e,s){o(),e?(console.error(e),res.send("Error "+e)):i.query("SELECT id, nome, email, mensagem, date FROM budget_message order by id desc",function(e,s){o(),n(!0),io.emit("real-time-data",{r:s.rows,html:file.toString()})})})})}),e.on("searchLike",function(e,n){pg.connect(process.env.DATABASE_URL,function(s,r,i){if(e.length>0)var o="where (nome ilike '%"+e+"%' or email ilike '%"+e+"%' or mensagem ilike '%"+e+"%' or telefone ilike '%"+e+"%' or celular ilike '%"+e+"%' or date ilike '%"+e+"%')";else var o="";r.query("SELECT id, nome, email, mensagem, date FROM budget_message "+o+" order by id desc",function(e,s){i(),e||n({r:s.rows,html:file.toString()})})})}),e.on("del-item",function(e){Array.isArray(e)&&e.length>0&&pg.connect(process.env.DATABASE_URL,function(n,s,r){s.query("delete from budget_message where id in ("+e.join()+")",function(n,s){r(),n||io.emit("real-time-data",{id:e,removeOne:!0})})})}),e.on("logindb",function(n,s){n&&pg.connect(process.env.DATABASE_URL,function(r,i,o){i.query("select count(*) from admin where login='"+pb(n.l)+"' and senha='"+pb(n.s)+"'",function(n,r){o(),n?console.error(n):(1==r.rows[0].count?(e.handshake.session.login=!0,s(e.handshake.session.login)):(e.handshake.session.login=!1,s(e.handshake.session.login)),e.handshake.session.save())})})})}),http.listen(PORT,function(){console.log("listening on *:"+PORT)});